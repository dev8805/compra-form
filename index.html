<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Compra</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            max-width: 500px;
            width: 100%;
            padding: 40px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .nombre-negocio {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        
        h1 {
            font-size: 28px;
            color: #333;
            margin: 0;
        }
        
        .form-group {
            margin-bottom: 24px;
            position: relative;
        }
        
        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .required::after {
            content: " *";
            color: #e74c3c;
        }
        
        .input-wrapper {
            position: relative;
        }
        
        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: inherit;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .autocomplete-list.active {
            display: block;
        }
        
        .autocomplete-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }
        
        .autocomplete-item:hover {
            background-color: #f5f7ff;
        }
        
        .autocomplete-item-nombre {
            font-weight: 600;
            color: #333;
        }
        
        .autocomplete-item-codigo {
            font-size: 12px;
            color: #999;
        }
        
        .medida-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .radio-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .radio-group input[type="radio"] {
            width: auto;
            margin: 0;
            cursor: pointer;
        }
        
        .radio-group label {
            margin-bottom: 0;
            font-weight: 400;
            cursor: pointer;
        }
        
        .valor-total {
            background: #f5f7ff;
            padding: 16px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }
        
        .valor-total-input {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-family: inherit;
        }
        
        .valor-total-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .error {
            background-color: #fee;
            border: 2px solid #f99;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .success {
    background-color: #efe;
    border: 2px solid #9f9;
    color: #2d5016;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 13px;
    white-space: pre-line;
    font-family: 'Courier New', monospace;
    line-height: 1.6;
}
        
        .hidden {
            display: none;
        }

        #btnNuevaCompra {
    margin-top: 20px;
    background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
}

#btnNuevaCompra:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(39, 174, 96, 0.4);
}
        
        .info-stock {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }

        .debug-info {
            font-size: 11px;
            color: #999;
            margin-top: 10px;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="nombre-negocio" id="nombreNegocio">Cargando...</div>
            <h1>üì¶ Registrar Compra</h1>
        </div>
        
        <div id="error" class="error hidden"></div>
        <div id="success" class="success hidden"></div>
        
        <div class="debug-info" id="debugInfo">Cargando productos...</div>
        
        <div id="compraForm">
            <!-- Producto con autocompletado -->
            <div class="form-group">
                <label for="producto" class="required">Producto</label>
                <div class="input-wrapper">
                    <input 
                        type="text" 
                        id="producto" 
                        placeholder="Escribe para buscar..." 
                        autocomplete="off"
                        required
                    >
                    <div class="autocomplete-list" id="autocompleteList"></div>
                </div>
                <div class="info-stock" id="stockInfo"></div>
            </div>
            
            <!-- Medida de Compra -->
            <div class="form-group">
                <label class="required">Medida de Compra</label>
                <div class="medida-options" id="medidaOptions">
                    <p style="color: #888;">Selecciona un producto primero</p>
                </div>
            </div>
            
            <!-- Cantidad -->
            <div class="form-group">
                <label for="cantidad" class="required">Cantidad</label>
                <input 
                    type="number" 
                    id="cantidad" 
                    placeholder="Ej: 5" 
                    step="0.01" 
                    required
                >
            </div>
            
            <!-- Valor Total -->
            <div class="form-group">
                <label for="valorTotalInput" class="required">Valor Total Compra</label>
                <div class="valor-total">
                    <input 
                        type="number" 
                        id="valorTotalInput" 
                        placeholder="Ingresa el valor total" 
                        step="0.01"
                        required
                        class="valor-total-input"
                    >
                </div>
            </div>
            
            <button type="button" id="submitBtn" onclick="enviarCompra()">Registrar Compra</button>
        </div>
    </div>
    
    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://fqujxgwresrdvvfkmdgv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZxdWp4Z3dyZXNyZHZ2ZmttZGd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDc2NzQsImV4cCI6MjA3MDA4MzY3NH0._XwIEgRXVzSYZI7Y6nNZ9jfmrjjIw6Dy1RTP7z0qKCI';
        
        // Obtener token y tenant_id de URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const tenantId = urlParams.get('tenant_id');

        // Validar par√°metros
        if (!token || !tenantId) {
            document.body.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div style="background: white; padding: 40px; border-radius: 12px; text-align: center; max-width: 500px;">
                        <h2 style="color: #e74c3c; margin-bottom: 20px;">‚ùå Error de Acceso</h2>
                        <p style="color: #666; margin-bottom: 20px;">Este enlace no es v√°lido o ha expirado.</p>
                        <p style="color: #888; font-size: 14px;">Por favor, solicita un nuevo enlace escribiendo "registrar compra" por WhatsApp.</p>
                    </div>
                </div>
            `;
            throw new Error('Token o tenant_id no proporcionados');
        }

        console.log('Token:', token);
        console.log('Tenant ID:', tenantId);
        
        let productosData = [];
        let productoSeleccionado = null;
        let datosUsuario = {};
        
        // Elementos del DOM
        const productoInput = document.getElementById('producto');
        const autocompleteList = document.getElementById('autocompleteList');
        const cantidadInput = document.getElementById('cantidad');
        const valorTotalInput = document.getElementById('valorTotalInput');
        const medidaOptionsDiv = document.getElementById('medidaOptions');
        const errorDiv = document.getElementById('error');
        const successDiv = document.getElementById('success');
        const stockInfo = document.getElementById('stockInfo');
        const nombreNegocioDiv = document.getElementById('nombreNegocio');
        const debugInfo = document.getElementById('debugInfo');
        const submitBtn = document.getElementById('submitBtn');
        
        // Cargar nombre del negocio
        async function cargarNombreNegocio() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/tenants?tenant_id=eq.${tenantId}&select=nombre_negocio`,
                    {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Datos tenant:', data);
                    if (data.length > 0) {
                        nombreNegocioDiv.textContent = data[0].nombre_negocio.toUpperCase();
                    }
                }
            } catch (error) {
                console.error('Error cargando nombre negocio:', error);
                nombreNegocioDiv.textContent = 'MI NEGOCIO';
            }
        }

        // Obtener datos del usuario desde el token
        async function obtenerDatosUsuario() {
    try {
        const response = await fetch(
            `${SUPABASE_URL}/rest/v1/form_tokens?token=eq.${token}&tenant_id=eq.${tenantId}&select=*`,
                    {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.length > 0) {
                        const tokenData = data[0];
                        
                        // Obtener datos del usuario
                        const userResponse = await fetch(
                            `${SUPABASE_URL}/rest/v1/usuarios?user_id=eq.${tokenData.user_id}&select=*`,
                            {
                                headers: {
                                    'apikey': SUPABASE_KEY,
                                    'Authorization': `Bearer ${SUPABASE_KEY}`
                                }
                            }
                        );
                        
                        if (userResponse.ok) {
                            const userData = await userResponse.json();
                            if (userData.length > 0) {
    // Parsear permisos si vienen como string desde la base de datos
    let permisos = userData[0].permisos;
    if (typeof permisos === 'string') {
        try {
            permisos = JSON.parse(permisos);
        } catch (e) {
            console.error('Error parseando permisos:', e);
            permisos = {};
        }
    }
    
    datosUsuario = {
        tenant_id: tokenData.tenant_id,
        user_id: tokenData.user_id,
        numero_telefono: userData[0].numero_telefono,
        nombre_usuario: userData[0].nombre,
        permisos: permisos, // Ya parseado como objeto
        rol: userData[0].rol,
        instancia: userData[0].instancia || 'default'
    };
    console.log('Datos usuario cargados:', datosUsuario);
}
                        }
                    }
                }
            } catch (error) {
                console.error('Error obteniendo datos usuario:', error);
            }
        }
        
        // Cargar productos de Supabase
        async function cargarProductos() {
            try {
                debugInfo.textContent = 'Cargando productos...';
                
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/productos?tenant_id=eq.${tenantId}&activo=eq.true&select=*`,
                    {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                productosData = await response.json();
                console.log('Productos cargados:', productosData);
                
                if (productosData.length === 0) {
                    debugInfo.textContent = '‚ö†Ô∏è No hay productos activos registrados';
                    mostrarError('No hay productos disponibles. Por favor, registra productos primero.');
                } else {
                    debugInfo.textContent = `‚úÖ ${productosData.length} productos cargados correctamente`;
                    setTimeout(() => {
                        debugInfo.classList.add('hidden');
                    }, 3000);
                }
                
            } catch (error) {
                console.error('Error completo:', error);
                debugInfo.textContent = `‚ùå Error: ${error.message}`;
                mostrarError('Error cargando productos: ' + error.message);
            }
        }
        
        // Filtrar y mostrar autocomplete
        productoInput.addEventListener('input', (e) => {
            const valor = e.target.value.toLowerCase().trim();
            
            if (valor.length === 0) {
                autocompleteList.classList.remove('active');
                productoSeleccionado = null;
                stockInfo.textContent = '';
                medidaOptionsDiv.innerHTML = '<p style="color: #888;">Selecciona un producto primero</p>';
                return;
            }
            
            const filtrados = productosData.filter(p => 
                p.producto.toLowerCase().includes(valor) ||
                p.codigo.toLowerCase().includes(valor) ||
                (p.apodos_input && p.apodos_input.toLowerCase().includes(valor))
            );
            
            console.log('B√∫squeda:', valor, 'Encontrados:', filtrados.length);
            mostrarAutocomplete(filtrados);
        });
        
        // Mostrar lista de autocompletado
        function mostrarAutocomplete(productos) {
            autocompleteList.innerHTML = '';
            
            if (productos.length === 0) {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.innerHTML = '<div class="autocomplete-item-nombre" style="color: #999;">No se encontraron productos</div>';
                autocompleteList.appendChild(div);
                autocompleteList.classList.add('active');
                return;
            }
            
            productos.forEach(prod => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.innerHTML = `
                    <div class="autocomplete-item-nombre">${prod.producto}</div>
                    <div class="autocomplete-item-codigo">C√≥digo: ${prod.codigo} | Stock: ${prod.stock_actual} ${prod.unidad_peso}</div>
                `;
                div.addEventListener('click', () => seleccionarProducto(prod));
                autocompleteList.appendChild(div);
            });
            
            autocompleteList.classList.add('active');
        }
        
        // Seleccionar producto del autocomplete
        function seleccionarProducto(producto) {
            console.log('Producto seleccionado:', producto);
            productoSeleccionado = producto;
            productoInput.value = `${producto.producto} (${producto.codigo})`;
            autocompleteList.classList.remove('active');
            
            // Mostrar stock
            stockInfo.textContent = `Stock actual: ${producto.stock_actual} ${producto.unidad_peso}`;
            
            // Generar opciones de medida
            generarOpcionesMedida();
        }
        
        // Generar opciones de medida
        function generarOpcionesMedida() {
            medidaOptionsDiv.innerHTML = '';
            
            const medidas = [
                {
                    value: productoSeleccionado.unidad_peso,
                    label: productoSeleccionado.unidad_peso
                },
                {
                    value: productoSeleccionado.unidad_compra,
                    label: productoSeleccionado.unidad_compra
                }
            ];
            
            medidas.forEach((medida, index) => {
                const div = document.createElement('div');
                div.className = 'radio-group';
                
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'medida';
                radio.value = medida.value;
                radio.id = `medida_${index}`;
                radio.required = true;
                if (index === 0) radio.checked = true;
                
                const label = document.createElement('label');
                label.htmlFor = `medida_${index}`;
                label.textContent = medida.label;
                
                div.appendChild(radio);
                div.appendChild(label);
                medidaOptionsDiv.appendChild(div);
            });
        }

        // ============================================
// FUNCI√ìN: Calcular unidades ingresadas seg√∫n tipo de venta
// ============================================
function calcularUnidadesIngresadas(producto, cantidad, unidadMedida) {
    const stockActual = parseFloat(producto.stock_actual) || 0;
    const tipoVenta = producto.tipo_venta;
    const unidadPeso = producto.unidad_peso;
    const factor = parseFloat(producto.factor_unidades) || 1;
    
    let unidadesIngresadas;
    
    if (tipoVenta === 'peso') {
        // Productos por peso (libras, kilos, etc.)
        const unidadMedidaNorm = unidadMedida.toLowerCase().replace(/s$/, '');
        const unidadPesoNorm = unidadPeso.toLowerCase().replace(/s$/, '');
        
        if (unidadMedidaNorm === unidadPesoNorm) {
            // Unidad directa
            unidadesIngresadas = cantidad;
        } else {
            // Con factor
            unidadesIngresadas = cantidad * factor;
        }
    } else if (tipoVenta === 'medida') {
        // Productos por medida (metros, pulgadas, etc.)
        const unidadMedidaNorm = unidadMedida.toLowerCase().replace(/s$/, '');
        const unidadPesoNorm = unidadPeso.toLowerCase().replace(/s$/, '');
        
        if (unidadMedidaNorm === unidadPesoNorm) {
            // Unidad directa
            unidadesIngresadas = cantidad;
        } else {
            // Con factor (ej: 1 rollo = 50 metros)
            unidadesIngresadas = cantidad * factor;
        }
    } else {
        // Productos por unidad (tipo_venta === 'unidad')
        if (unidadMedida === 'unidades' || unidadMedida === 'unidad') {
            unidadesIngresadas = cantidad;
        } else {
            unidadesIngresadas = cantidad * factor;
        }
    }
    
    const nuevoStock = stockActual + unidadesIngresadas;
    
    return {
        unidadesIngresadas,
        nuevoStock,
        stockAnterior: stockActual
    };
}
       
        // Validar que todos los campos est√©n llenos
        function validarFormulario() {
            if (!productoSeleccionado) {
                mostrarError('Debes seleccionar un producto');
                return false;
            }
            
            if (!cantidadInput.value || parseFloat(cantidadInput.value) <= 0) {
                mostrarError('La cantidad debe ser mayor a 0');
                return false;
            }
            
            if (!valorTotalInput.value || parseFloat(valorTotalInput.value) <= 0) {
                mostrarError('El valor total debe ser mayor a 0');
                return false;
            }
            
            if (!document.querySelector('input[name="medida"]:checked')) {
                mostrarError('Debes seleccionar una medida de compra');
                return false;
            }
            
            return true;
        }
        
        // ============================================
// ENVIAR COMPRA - PROCESO COMPLETO EN EL CLIENTE
// ============================================
async function enviarCompra() {
    if (!validarFormulario()) return;
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Registrando...';
    
    try {
        const medidaSeleccionada = document.querySelector('input[name="medida"]:checked')?.value;
        const cantidad = parseFloat(cantidadInput.value);
        const valorTotal = parseFloat(valorTotalInput.value);
        
        console.log('üì¶ Iniciando registro de compra...');
        
        // ============================================
        // PASO 1: Obtener zona horaria del tenant
        // ============================================
        const tenantResponse = await fetch(
            `${SUPABASE_URL}/rest/v1/tenants?tenant_id=eq.${tenantId}&select=zona_horaria`,
            {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                }
            }
        );
        
        if (!tenantResponse.ok) {
            throw new Error('Error obteniendo configuraci√≥n del negocio');
        }
        
        const tenantData = await tenantResponse.json();
        const zonaHoraria = tenantData[0]?.zona_horaria || 'America/Bogota';
        
        // Fecha actual en zona horaria del tenant
        const fechaActual = new Date().toLocaleString('es-CO', {
            timeZone: zonaHoraria,
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        });
        
        const fechaSQL = new Date().toLocaleDateString('en-CA', {
            timeZone: zonaHoraria
        });
        
        // ============================================
        // PASO 2: Calcular unidades y nuevo stock
        // ============================================
        const calculoStock = calcularUnidadesIngresadas(
            productoSeleccionado,
            cantidad,
            medidaSeleccionada
        );
        
        const { unidadesIngresadas, nuevoStock, stockAnterior } = calculoStock;
        
        // Calcular nuevo costo unitario
        const nuevoCosto = unidadesIngresadas > 0 
            ? (valorTotal / unidadesIngresadas) 
            : 0;
        
        console.log('üìä C√°lculos:', {
            unidadesIngresadas,
            stockAnterior,
            nuevoStock,
            nuevoCosto
        });

        // AGREGAR:
const payloadMovimiento = {
    tenant_id: tenantId,
    producto_id: productoSeleccionado.producto_id,
    codigo: productoSeleccionado.codigo,
    cantidad: unidadesIngresadas,
    tipo: 'entrada',
    costo_unitario: nuevoCosto,
    costo_total: valorTotal,
    razon: `Entrada de ${cantidad} ${medidaSeleccionada}`,
    user_id: datosUsuario.user_id,
    activo: true,
    created_at: new Date().toISOString()
};

console.log('üì§ Payload que se enviar√° a movimientos_inventario:', JSON.stringify(payloadMovimiento, null, 2));
        
        // ============================================
        // PASO 3: Insertar en movimientos_inventario
        // ============================================
        const movimientoResponse = await fetch(
            `${SUPABASE_URL}/rest/v1/movimientos_inventario`,
            {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify(payloadMovimiento)
            }
        );
        
        if (!movimientoResponse.ok) {
            const errorText = await movimientoResponse.text();
console.error('‚ùå Error Response Status:', movimientoResponse.status);
console.error('‚ùå Error Response Headers:', Object.fromEntries(movimientoResponse.headers.entries()));
console.error('‚ùå Error Response Body:', errorText);

let errorData;
try {
    errorData = JSON.parse(errorText);
} catch (e) {
    errorData = { message: errorText };
}

throw new Error(`Error ${movimientoResponse.status} registrando movimiento: ${errorData.message || errorData.hint || errorText}`);
        }
        
        const movimientoData = await movimientoResponse.json();
        console.log('‚úÖ Movimiento registrado:', movimientoData[0]);
        
        // ============================================
        // PASO 4: Actualizar stock Y costo en productos
        // ============================================
        const updateProductoResponse = await fetch(
            `${SUPABASE_URL}/rest/v1/productos?producto_id=eq.${productoSeleccionado.producto_id}`,
            {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify({
                    stock_actual: nuevoStock,
                    costo: nuevoCosto,
                    updated_at: new Date().toISOString(),
                    updated_by: datosUsuario.user_id
                })
            }
        );
        
        if (!updateProductoResponse.ok) {
            throw new Error('Error actualizando stock del producto');
        }
        
        const productoActualizado = await updateProductoResponse.json();
        console.log('‚úÖ Stock actualizado:', productoActualizado[0]);
        
        // ============================================
        // PASO 5: Registrar movimiento de caja
        // ============================================
        
        // 5.1: Verificar si existe caja_diaria para hoy
        const cajaHoyResponse = await fetch(
            `${SUPABASE_URL}/rest/v1/caja_diaria?tenant_id=eq.${tenantId}&fecha=eq.${fechaSQL}&select=*`,
            {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                }
            }
        );
        
        const cajaHoyData = await cajaHoyResponse.json();
        let cajaEsperada = 0;
        
        if (cajaHoyData.length > 0) {
            // Actualizar caja existente
            const cajaActual = cajaHoyData[0];
            const comprasActuales = parseFloat(cajaActual.compras_totales) || 0;
            const nuevasCompras = comprasActuales + valorTotal;
            
            const baseInicial = parseFloat(cajaActual.base_inicial) || 0;
            const ventasTotales = parseFloat(cajaActual.ventas_totales) || 0;
            const gastosTotales = parseFloat(cajaActual.gastos_totales) || 0;
            
            cajaEsperada = baseInicial + ventasTotales - gastosTotales - nuevasCompras;

const updateCajaResponse = await fetch(
    `${SUPABASE_URL}/rest/v1/caja_diaria?id=eq.${cajaActual.id}`,
                {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        compras_totales: nuevasCompras,
                        caja_esperada: cajaEsperada,
                        updated_at: new Date().toISOString()
                    })
                }
            );

if (!updateCajaResponse.ok) {
    const errorText = await updateCajaResponse.text();
    console.error('‚ùå Error actualizando caja:', errorText);
    throw new Error('Error actualizando caja diaria');
}

console.log('‚úÖ Caja diaria actualizada');
        } else {
            // Crear nuevo registro de caja
            // Buscar caja del d√≠a anterior
            const cajaAnteriorResponse = await fetch(
                `${SUPABASE_URL}/rest/v1/caja_diaria?tenant_id=eq.${tenantId}&fecha=lt.${fechaSQL}&select=caja_esperada&order=fecha.desc&limit=1`,
                {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                }
            );
            
            const cajaAnteriorData = await cajaAnteriorResponse.json();
            const cajaAnterior = cajaAnteriorData.length > 0 
                ? parseFloat(cajaAnteriorData[0].caja_esperada) 
                : 0;
            
            cajaEsperada = cajaAnterior - valorTotal;

const insertCajaResponse = await fetch(
    `${SUPABASE_URL}/rest/v1/caja_diaria`,
    {
        method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tenant_id: tenantId,
                        fecha: fechaSQL,
                        caja_dia_anterior: cajaAnterior,
                        base_agregada: 0,
                        base_inicial: cajaAnterior,
                        ventas_totales: 0,
                        gastos_totales: 0,
                        compras_totales: valorTotal,
                        consumos_totales: 0,
                        mermas_totales: 0,
                        caja_esperada: cajaEsperada,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                }
            );

if (!insertCajaResponse.ok) {
    const errorText = await insertCajaResponse.text();
    console.error('‚ùå Error creando caja:', errorText);
    throw new Error('Error creando caja diaria');
}

console.log('‚úÖ Caja diaria creada');
        }
        
        // ============================================
        // PASO 6: Marcar token como usado
        // ============================================
        await fetch(
            `${SUPABASE_URL}/rest/v1/form_tokens?token=eq.${token}`,
            {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    usos: 1,
                    ultimo_uso_at: new Date().toISOString()
                })
            }
        );
        
        // ============================================
        // PASO 7: Mostrar confirmaci√≥n
        // ============================================
        
        // Determinar unidad de stock seg√∫n tipo de venta
let unidadStock;
let stockFormateado;

if (productoSeleccionado.tipo_venta === 'unidad') {
    unidadStock = 'und';
    stockFormateado = Math.round(nuevoStock);
} else if (productoSeleccionado.tipo_venta === 'peso') {
    unidadStock = productoSeleccionado.unidad_peso || 'libras';
    stockFormateado = nuevoStock.toFixed(2);
} else if (productoSeleccionado.tipo_venta === 'medida') {
    unidadStock = productoSeleccionado.unidad_peso || 'metros';
    stockFormateado = nuevoStock.toFixed(2);
} else {
    unidadStock = 'und';
    stockFormateado = Math.round(nuevoStock);
}
        
        const valorFormateado = `$${valorTotal.toLocaleString('es-CO', {maximumFractionDigits: 0})}`;
        const cajaFormateada = `$${cajaEsperada.toLocaleString('es-CO', {maximumFractionDigits: 0})}`;
        
        const mensajeExito = `
‚úÖ Registro de entrada a Inventario
${fechaActual}

[${productoSeleccionado.codigo}] ${cantidad} ${medidaSeleccionada} ${productoSeleccionado.producto} - ${valorFormateado} / Stock: ${stockFormateado} ${unidadStock}

üí∞ Total de la COMPRA: ${valorFormateado}
üíº Caja esperada: ${cajaFormateada}
        `.trim();
        
        mostrarExito(mensajeExito);

        // Guardar datos para posible reversa
        window.ultimaCompra = {
            movimientoId: movimientoData[0].movimiento_id,
            productoId: productoSeleccionado.producto_id,
            unidadesIngresadas,
            stockAnterior,
            nuevoStock,
            costoAnterior: productoSeleccionado.costo,
            nuevoCosto,
            valorTotal,
            cajaEsperada,
            fechaSQL,
            producto: productoSeleccionado.producto,
            codigo: productoSeleccionado.codigo
        };
        
        // Ocultar formulario y mostrar bot√≥n de nueva compra
document.getElementById('compraForm').classList.add('hidden');
submitBtn.classList.add('hidden');

// Crear bot√≥n de nueva compra si no existe
let btnNuevaCompra = document.getElementById('btnNuevaCompra');
if (!btnNuevaCompra) {
    btnNuevaCompra = document.createElement('button');
    btnNuevaCompra.id = 'btnNuevaCompra';
    btnNuevaCompra.textContent = '‚ûï Registrar Nueva Compra';
    btnNuevaCompra.onclick = resetearFormulario;
    successDiv.insertAdjacentElement('afterend', btnNuevaCompra);
}
btnNuevaCompra.classList.remove('hidden');

   // Crear bot√≥n de reversa si no existe
let btnReversar = document.getElementById('btnReversar');
if (!btnReversar) {
    btnReversar = document.createElement('button');
    btnReversar.id = 'btnReversar';
    btnReversar.textContent = 'üîÑ Reversar Compra';
    btnReversar.style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
    btnReversar.onclick = reversarCompra;
    btnNuevaCompra.insertAdjacentElement('afterend', btnReversar);
}
btnReversar.classList.remove('hidden');

// Recargar productos para actualizar stock
cargarProductos();
        
    } catch (error) {
    console.error('‚ùå Error al registrar:', error);
    console.error('‚ùå Stack trace:', error.stack);
    console.error('‚ùå Datos del contexto:', {
        tenantId,
        userId: datosUsuario.user_id,
        producto: productoSeleccionado?.codigo,
        cantidad,
        medida: document.querySelector('input[name="medida"]:checked')?.value
    });
    mostrarError('Error al registrar la compra: ' + error.message);
    submitBtn.disabled = false;
    submitBtn.textContent = 'Registrar Compra';
    // Limpiar datos de √∫ltima compra
    window.ultimaCompra = null;
}
}
        
        // Mostrar errores
        function mostrarError(mensaje) {
            errorDiv.textContent = mensaje;
            errorDiv.classList.remove('hidden');
            successDiv.classList.add('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }
        
        // Mostrar √©xito
        function mostrarExito(mensaje) {
            successDiv.textContent = mensaje;
            successDiv.classList.remove('hidden');
            errorDiv.classList.add('hidden');
        }

        // Resetear formulario para nueva compra
function resetearFormulario() {
    productoInput.value = '';
    cantidadInput.value = '';
    valorTotalInput.value = '';
    productoSeleccionado = null;
    medidaOptionsDiv.innerHTML = '<p style="color: #888;">Selecciona un producto primero</p>';
    stockInfo.textContent = '';
    successDiv.classList.add('hidden');
    errorDiv.classList.add('hidden');
    submitBtn.disabled = false;
    submitBtn.textContent = 'Registrar Compra';
    
    // Mostrar formulario y ocultar bot√≥n de nueva compra
    document.getElementById('compraForm').classList.remove('hidden');
    submitBtn.classList.remove('hidden');
    document.getElementById('btnNuevaCompra')?.classList.add('hidden');
    document.getElementById('btnReversar')?.classList.add('hidden');
    
    // Focus en el input de producto
    productoInput.focus();
}
        // ============================================
// REVERSAR COMPRA
// ============================================
async function reversarCompra() {
    if (!window.ultimaCompra) {
        mostrarError('No hay compra para reversar');
        return;
    }
    
    // Confirmar acci√≥n
    if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de reversar esta compra?\n\nEsto deshar√° todos los cambios realizados:\n- Stock del producto\n- Costo unitario\n- Caja diaria')) {
        return;
    }
    
    const btnReversar = document.getElementById('btnReversar');
    btnReversar.disabled = true;
    btnReversar.textContent = 'Reversando...';
    
    try {
        const { 
            movimientoId, 
            productoId, 
            stockAnterior, 
            costoAnterior, 
            valorTotal, 
            fechaSQL,
            producto,
            codigo
        } = window.ultimaCompra;
        
        console.log('üîÑ Iniciando reversa de compra...');
        
        // ============================================
        // PASO 1: Marcar movimiento como inactivo
        // ============================================
        const updateMovimientoResponse = await fetch(
            `${SUPABASE_URL}/rest/v1/movimientos_inventario?movimiento_id=eq.${movimientoId}`,
            {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify({
                    activo: false,
                    updated_at: new Date().toISOString(),
                    observacion: 'Movimiento reversado'
                })
            }
        );
        
        if (!updateMovimientoResponse.ok) {
            throw new Error('Error marcando movimiento como inactivo');
        }
        
        console.log('‚úÖ Movimiento marcado como inactivo');
        
        // ============================================
        // PASO 2: Restaurar stock y costo del producto
        // ============================================
        const restaurarProductoResponse = await fetch(
            `${SUPABASE_URL}/rest/v1/productos?producto_id=eq.${productoId}`,
            {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify({
                    stock_actual: stockAnterior,
                    costo: costoAnterior,
                    updated_at: new Date().toISOString(),
                    updated_by: datosUsuario.user_id
                })
            }
        );
        
        if (!restaurarProductoResponse.ok) {
            throw new Error('Error restaurando stock del producto');
        }
        
        console.log('‚úÖ Stock restaurado:', stockAnterior);
        
        // ============================================
        // PASO 3: Restaurar caja diaria
        // ============================================
        
        // Obtener caja actual
        const cajaResponse = await fetch(
            `${SUPABASE_URL}/rest/v1/caja_diaria?tenant_id=eq.${tenantId}&fecha=eq.${fechaSQL}&select=*`,
            {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                }
            }
        );
        
        if (!cajaResponse.ok) {
            throw new Error('Error obteniendo caja diaria');
        }
        
        const cajaData = await cajaResponse.json();
        
        if (cajaData.length > 0) {
            const cajaActual = cajaData[0];
            const comprasActuales = parseFloat(cajaActual.compras_totales) || 0;
            const nuevasCompras = comprasActuales - valorTotal;
            
            const baseInicial = parseFloat(cajaActual.base_inicial) || 0;
            const ventasTotales = parseFloat(cajaActual.ventas_totales) || 0;
            const gastosTotales = parseFloat(cajaActual.gastos_totales) || 0;
            
            const cajaEsperadaRestaurada = baseInicial + ventasTotales - gastosTotales - nuevasCompras;
            
            const updateCajaResponse = await fetch(
                `${SUPABASE_URL}/rest/v1/caja_diaria?id=eq.${cajaActual.id}`,
                {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        compras_totales: nuevasCompras,
                        caja_esperada: cajaEsperadaRestaurada,
                        updated_at: new Date().toISOString()
                    })
                }
            );
            
            if (!updateCajaResponse.ok) {
                throw new Error('Error restaurando caja diaria');
            }
            
            console.log('‚úÖ Caja restaurada');
        }
        
        // ============================================
        // PASO 4: Mostrar confirmaci√≥n
        // ============================================
        const valorFormateado = `$${valorTotal.toLocaleString('es-CO', {maximumFractionDigits: 0})}`;
        
        const mensajeReversa = `
üîÑ COMPRA REVERSADA EXITOSAMENTE

Producto: [${codigo}] ${producto}
Monto reversado: ${valorFormateado}
Stock restaurado a: ${stockAnterior}

‚úÖ Todos los cambios han sido revertidos
        `.trim();
        
        mostrarExito(mensajeReversa);
        
        // Limpiar datos de √∫ltima compra
        window.ultimaCompra = null;
        
        // Ocultar bot√≥n de reversar
        btnReversar.classList.add('hidden');
        
        // Recargar productos
        await cargarProductos();
        
    } catch (error) {
        console.error('‚ùå Error reversando compra:', error);
        mostrarError('Error al reversar la compra: ' + error.message);
        btnReversar.disabled = false;
        btnReversar.textContent = 'üîÑ Reversar Compra';
    }
}
        
        // Cerrar autocomplete al hacer click afuera
        document.addEventListener('click', (e) => {
            if (e.target !== productoInput && !autocompleteList.contains(e.target)) {
                autocompleteList.classList.remove('active');
            }
        });
        
        // Inicializar
        console.log('Tenant ID:', tenantId);
        cargarNombreNegocio();
        obtenerDatosUsuario();
        cargarProductos();
    </script>
</body>
</html>
